<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Pedidos</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h1 { text-align: center; }
  .pedido { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; background: #fff; border-radius: 8px; }
  .pedido h2 { margin-top: 0; }
  .section { margin-bottom: 10px; }
  .section label { display: block; margin-bottom: 5px; font-weight: bold; }
  .lista li { display: inline-block; padding: 5px 10px; margin: 2px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; }
  .lista li.selected { background: #4CAF50; color: white; }
  input.qtd { width: 40px; text-align: center; }
  #pedidosContainer { margin-bottom: 20px; }
  #totalGeral { font-weight: bold; margin-bottom: 20px; }
  button { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: none; border-radius: 5px; background: #2196F3; color: #fff; }
  button:hover { background: #1976D2; }
  .hidden { display: none; }
  input[readonly] { background: #eee; }
</style>
</head>
<body>

<h1>Sistema de Pedidos</h1>

<div id="pedidosContainer"></div>

<button id="adicionarPedido">Adicionar Pedido</button>
<button id="enviarWhats">Enviar WhatsApp</button>
<button id="gerarPDF">Gerar PDF</button>

<div id="totalGeral">Total Geral: R$ 0,00</div>

<!-- Template de pedido -->
<template id="pedidoTemplate">
  <div class="pedido" data-index="">
    <h2>Pedido <span class="numPedido"></span></h2>
    <div class="section">
      <label>Nome do Cliente:</label>
      <input type="text" class="nomeCliente" placeholder="Digite o nome">
    </div>

    <div class="section">
      <label>Marmita:</label>
      <label><input type="radio" name="marmita" value="Tradicional"> Tradicional (R$ 25,00)</label>
      <label><input type="radio" name="marmita" value="Vegetariana"> Vegetariana (R$ 25,00)</label>
      <label><input type="radio" name="marmita" value="Especial"> Especial (R$ 30,00)</label>
    </div>

    <div class="section">
      <label>Carnes:</label>
      <ul class="lista carnes">
        <li data-item="Frango">Frango</li>
        <li data-item="Carne Bovina">Carne Bovina</li>
        <li data-item="Peixe">Peixe</li>
      </ul>
    </div>

    <div class="section">
      <label>Acompanhamentos:</label>
      <ul class="lista acompanhamentos">
        <li data-item="Arroz">Arroz</li>
        <li data-item="Feij√£o">Feij√£o</li>
        <li data-item="Salada">Salada</li>
        <li data-item="Batata Frita">Batata Frita</li>
      </ul>
    </div>

    <div class="section">
      <label>Refrigerantes:</label>
      <ul class="lista refrigerantes">
        <li data-item="Coca-Cola">Coca-Cola <input type="number" class="qtd" min="0" value="0"></li>
        <li data-item="Guaran√°">Guaran√° <input type="number" class="qtd" min="0" value="0"></li>
        <li data-item="Fanta">Fanta <input type="number" class="qtd" min="0" value="0"></li>
      </ul>
    </div>

    <div class="section">
      <label>Adicionais:</label>
      <input type="text" class="adicionais" placeholder="Ex: Maionese extra">
    </div>

    <div class="section">
      <label>Observa√ß√£o:</label>
      <input type="text" class="observacao" placeholder="Ex: Sem cebola">
    </div>

    <div class="section">
      <label>Entrega / Retirada:</label>
      <select class="localEntrega">
        <option value="Retirada" data-taxa="0">Retirada</option>
        <option value="Bairro A" data-taxa="5">Bairro A (R$5)</option>
        <option value="Bairro B" data-taxa="8">Bairro B (R$8)</option>
      </select>
    </div>

    <div class="section enderecoContainer hidden">
      <label>Endere√ßo:</label>
      <input type="text" class="endereco" placeholder="Digite o endere√ßo">
      <div class="taxaEntregaInfo"></div>
    </div>

    <div class="section">
      <label>Total do Pedido:</label>
      <div class="totalPedido">R$ 0,00</div>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const pedidosContainer = document.getElementById("pedidosContainer");
  const adicionarPedidoBtn = document.getElementById("adicionarPedido");
  const enviarWhatsBtn = document.getElementById("enviarWhats");
  const gerarPDFBtn = document.getElementById("gerarPDF");
  const totalGeralDiv = document.getElementById("totalGeral");
  const pedidoTemplate = document.getElementById("pedidoTemplate").content;

  let pedidos = [];

  // Pre√ßos
  const precos = {
    marmita: { Tradicional: 25, Vegetariana: 25, Especial: 30 },
    carnes: 0, // inclusa na marmita
    acompanhamentos: 0, // inclusos
    refrigerantes: { "Coca-Cola": 5, "Guaran√°": 5, "Fanta": 5 }
  };

  // Salvar/Buscar clientes
  function salvarCliente(cliente) {
    if(!cliente.nome) return;
    const clientes = JSON.parse(localStorage.getItem('clientes') || '{}');
    clientes[cliente.nome] = {
      marmita: cliente.marmita,
      carnes: cliente.carnes,
      acompanhamentos: cliente.acompanhamentos,
      refrigerantes: cliente.refrigerantes,
      adicionais: cliente.adicionais,
      observacao: cliente.observacao
    };
    localStorage.setItem('clientes', JSON.stringify(clientes));
  }

  function buscarCliente(nome) {
    const clientes = JSON.parse(localStorage.getItem('clientes') || '{}');
    return clientes[nome] || null;
  }

  // Criar novo pedido
  function criarPedido() {
    const clone = document.importNode(pedidoTemplate, true);
    const index = pedidos.length;
    clone.querySelector(".pedido").dataset.index = index;
    clone.querySelector(".numPedido").textContent = index + 1;

    const pedidoObj = {
      nome: "",
      marmita: "",
      carnes: [],
      acompanhamentos: [],
      refrigerantes: [],
      adicionais: "",
      observacao: "",
      localEntrega: "Retirada",
      endereco: "",
      taxaEntrega: 0,
      total: 0
    };
    pedidos.push(pedidoObj);

    const container = clone.querySelector(".pedido");

    // Nome do cliente com autocompletar
    const nomeInput = container.querySelector(".nomeCliente");
    nomeInput.addEventListener("input", e => {
      const nome = e.target.value.trim();
      pedidoObj.nome = nome;

      const dados = buscarCliente(nome);
      if(dados) {
        pedidoObj.marmita = dados.marmita;
        pedidoObj.carnes = dados.carnes;
        pedidoObj.acompanhamentos = dados.acompanhamentos;
        pedidoObj.refrigerantes = dados.refrigerantes;
        pedidoObj.adicionais = dados.adicionais;
        pedidoObj.observacao = dados.observacao;

        // Atualiza interface
        const radio = container.querySelector(`input[name="marmita"][value="${dados.marmita}"]`);
        if(radio) radio.checked = true;

        container.querySelectorAll(".carnes li").forEach(li => li.classList.toggle("selected", dados.carnes.includes(li.dataset.item)));
        container.querySelectorAll(".acompanhamentos li").forEach(li => li.classList.toggle("selected", dados.acompanhamentos.includes(li.dataset.item)));
        container.querySelectorAll(".refrigerantes li").forEach(li => {
          const r = dados.refrigerantes.find(rf => rf.nome === li.dataset.item);
          li.querySelector(".qtd").value = r ? r.qtd : 0;
          li.classList.toggle("selected", !!r && r.qtd>0);
        });

        container.querySelector(".adicionais").value = dados.adicionais || "";
        container.querySelector(".observacao").value = dados.observacao || "";
      }
      atualizarPedido(index);
    });

    // Marmita
    container.querySelectorAll('input[name="marmita"]').forEach(radio => {
      radio.addEventListener("change", e => {
        pedidoObj.marmita = e.target.value;
        atualizarPedido(index);
      });
    });

    // Carnes e Acompanhamentos
    container.querySelectorAll(".carnes li, .acompanhamentos li").forEach(li => {
      li.addEventListener("click", e => {
        li.classList.toggle("selected");
        const lista = li.parentElement.classList.contains("carnes") ? "carnes" : "acompanhamentos";
        pedidoObj[lista] = Array.from(container.querySelectorAll(`.${lista} li.selected`)).map(l => l.dataset.item);
        atualizarPedido(index);
      });
    });

    // Refrigerantes
    container.querySelectorAll(".refrigerantes li").forEach(li => {
      const input = li.querySelector(".qtd");
      input.addEventListener("input", () => {
        const qtd = parseInt(input.value) || 0;
        li.classList.toggle("selected", qtd>0);
        pedidoObj.refrigerantes = Array.from(container.querySelectorAll(".refrigerantes li.selected")).map(l => ({
          nome: l.dataset.item,
          qtd: parseInt(l.querySelector(".qtd").value)
        }));
        atualizarPedido(index);
      });
    });

    // Adicionais e Observa√ß√£o
    container.querySelector(".adicionais").addEventListener("input", e => {
      pedidoObj.adicionais = e.target.value;
    });
    container.querySelector(".observacao").addEventListener("input", e => {
      pedidoObj.observacao = e.target.value;
    });

    // Local de entrega
    const localSelect = container.querySelector(".localEntrega");
    const enderecoContainer = container.querySelector(".enderecoContainer");
    const enderecoInput = container.querySelector(".endereco");
    const taxaEntregaInfo = container.querySelector(".taxaEntregaInfo");

    function atualizarCampo() {
      const local = localSelect.value;
      const taxa = parseFloat(localSelect.selectedOptions[0].dataset.taxa || 0);
      pedidoObj.localEntrega = local;
      pedidoObj.taxaEntrega = taxa;

      if(local.toLowerCase() === "retirada") {
        enderecoContainer.classList.add("hidden");
        enderecoInput.value = "üìç Retirada no Local";
        enderecoInput.readOnly = true;
      } else {
        enderecoContainer.classList.remove("hidden");
        enderecoInput.value = "";
        enderecoInput.readOnly = false;
      }
      taxaEntregaInfo.textContent = local.toLowerCase()==="retirada" ? "üè† Retirar no Local" : `üèçÔ∏è Taxa de entrega: R$ ${taxa.toFixed(2)}`;
      atualizarPedido(index);
    }

    localSelect.addEventListener("change", atualizarCampo);
    enderecoInput.addEventListener("input", e => { pedidoObj.endereco = e.target.value; });

    // Atualizar total do pedido
    function atualizarPedido(i) {
      const p = pedidos[i];
      let total = 0;
      if(p.marmita) total += precos.marmita[p.marmita] || 0;
      p.refrigerantes.forEach(r => { total += (precos.refrigerantes[r.nome] || 0) * r.qtd; });
      total += p.taxaEntrega;
      p.total = total;

      container.querySelector(".totalPedido").textContent = `R$ ${total.toFixed(2)}`;
      atualizarTotalGeral();
    }

    function atualizarTotalGeral() {
      const totalGeral = pedidos.reduce((acc,p)=>acc+p.total,0);
      totalGeralDiv.textContent = `Total Geral: R$ ${totalGeral.toFixed(2)}`;
    }

    container.atualizarPedido = atualizarPedido.bind(null,index);

    pedidosContainer.appendChild(clone);
    atualizarCampo();
    atualizarPedido(index);
  }

  // Bot√µes
  adicionarPedidoBtn.addEventListener("click", criarPedido);

  enviarWhatsBtn.addEventListener("click", () => {
    pedidos.forEach(p => salvarCliente(p));
    const mensagem = pedidos.map((p,i)=> {
      let msg = `Pedido ${i+1}\nCliente: ${p.nome}\nMarmita: ${p.marmita}\nCarnes: ${p.carnes.join(", ")}\nAcompanhamentos: ${p.acompanhamentos.join(", ")}\nRefrigerantes: ${p.refrigerantes.map(r=>r.qtd+"x "+r.nome).join(", ")}\nAdicionais: ${p.adicionais}\nObserva√ß√£o: ${p.observacao}\nLocal: ${p.localEntrega}\nEndere√ßo: ${p.endereco}\nTotal: R$ ${p.total.toFixed(2)}`;
      return msg;
    }).join("\n\n");
    const url = `https://wa.me/5511999999999?text=${encodeURIComponent(mensagem)}`;
    window.open(url,"_blank");
  });

  gerarPDFBtn.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;
    pedidos.forEach((p,i) => {
      doc.text(`Pedido ${i+1}`,10,y); y+=6;
      doc.text(`Cliente: ${p.nome}`,10,y); y+=6;
      doc.text(`Marmita: ${p.marmita}`,10,y); y+=6;
      doc.text(`Carnes: ${p.carnes.join(", ")}`,10,y); y+=6;
      doc.text(`Acompanhamentos: ${p.acompanhamentos.join(", ")}`,10,y); y+=6;
      doc.text(`Refrigerantes: ${p.refrigerantes.map(r=>r.qtd+"x "+r.nome).join(", ")}`,10,y); y+=6;
      doc.text(`Adicionais: ${p.adicionais}`,10,y); y+=6;
      doc.text(`Observa√ß√£o: ${p.observacao}`,10,y); y+=6;
      doc.text(`Local: ${p.localEntrega}`,10,y); y+=6;
      doc.text(`Endere√ßo: ${p.endereco}`,10,y); y+=6;
      doc.text(`Total: R$ ${p.total.toFixed(2)}`,10,y); y+=10;
    });
    doc.save("pedidos.pdf");
  });

  // Inicializa com um pedido
  criarPedido();
});
</script>

</body>
</html>
